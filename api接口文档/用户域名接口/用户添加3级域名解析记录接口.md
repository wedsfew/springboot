# 用户添加3级域名解析记录接口文档

## 接口概述

本接口用于用户为自己的3级域名添加DNS解析记录，支持A、CNAME、MX、TXT等多种记录类型。

## 接口信息

- **接口标识**：`USER_ADD_DNS_RECORD`
- **请求路径**：`POST /api/user/dns-records`
- **接口描述**：用户添加3级域名DNS解析记录
- **认证要求**：需要JWT认证
- **适用业务单元**：用户域名解析记录管理

## 请求参数

### 必填参数

| 参数名称 | 类型 | 描述 | 示例值 |
|---------|------|------|--------|
| subdomainId | Long | 用户3级域名ID | 123 |
| name | String | 主机记录（如www、mail等，@表示主域名） | www |
| type | String | 记录类型（A、CNAME、MX、TXT等） | A |
| value | String | 记录值（如IP地址、域名等） | 192.168.1.1 |

### 可选参数

| 参数名称 | 类型 | 描述 | 默认值 | 示例值 |
|---------|------|------|--------|--------|
| line | String | 记录线路 | 默认 | 默认 |
| ttl | Integer | TTL值（秒，1-604800） | 600 | 600 |
| mx | Integer | MX优先级（1-20，仅MX记录需要） | null | 10 |
| weight | Integer | 权重（0-100，负载均衡） | null | 50 |
| remark | String | 备注信息 | null | 测试记录 |

## 请求格式

### JSON请求体格式

```json
{
  "subdomainId": 123,
  "name": "www",
  "type": "A",
  "value": "192.168.1.1",
  "line": "默认",
  "ttl": 600,
  "mx": null,
  "weight": null,
  "remark": "网站主页"
}
```

## 请求示例

### 添加A记录

```bash
curl -X POST "http://localhost:8080/api/user/dns-records" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '
  '
```

### 添加CNAME记录

```bash
curl -X POST "http://localhost:8080/api/user/dns-records" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "subdomainId": 123,
    "name": "blog",
    "type": "CNAME",
    "value": "example.com",
    "ttl": 600,
    "remark": "博客别名"
  }'
```

### 添加MX记录

```bash
curl -X POST "http://localhost:8080/api/user/dns-records" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "subdomainId": 123,
    "name": "@",
    "type": "MX",
    "value": "mail.example.com",
    "mx": 10,
    "ttl": 600,
    "remark": "邮件服务器"
  }'
```

## 响应格式

### 成功响应（状态码 200）

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 456,
    "userId": 789,
    "subdomainId": 123,
    "recordId": 162,
    "name": "www",
    "type": "A",
    "value": "192.168.1.1",
    "line": "默认",
    "lineId": "0",
    "ttl": 600,
    "mx": null,
    "weight": null,
    "status": "ENABLE",
    "remark": "网站主页",
    "monitorStatus": null,
    "updatedOn": null,
    "syncStatus": "SUCCESS",
    "syncError": null,
    "createTime": "2025-08-25T08:00:00",
    "updateTime": "2025-08-25T08:00:00"
  },
  "timestamp": "2025-08-25T08:00:00Z"
}
```

### 失败响应

#### 参数验证失败（400）

```json
{
  "code": 400,
  "message": "参数验证失败：记录值格式不正确",
  "data": null,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

#### 未授权（401）

```json
{
  "code": 401,
  "message": "未授权：需要有效的JWT令牌",
  "data": null,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

#### 权限不足（403）

```json
{
  "code": 403,
  "message": "无权限操作该子域名",
  "data": null,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

#### 子域名不存在（404）

```json
{
  "code": 404,
  "message": "子域名不存在",
  "data": null,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

#### 记录已存在（409）

```json
{
  "code": 409,
  "message": "DNS解析记录已存在",
  "data": null,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

#### 服务器错误（500）

```json
{
  "code": 500,
  "message": "DNS解析记录创建失败: 调用腾讯云DNSPod创建记录API失败",
  "data": null,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

## 业务流程

### 1. 前置验证
- JWT身份认证
- 参数格式验证
- 用户权限检查（是否拥有该3级域名）
- 子域名状态检查（必须为ACTIVE）
- 重复记录检查
- 记录值格式验证

### 2. 本地数据库操作
- 在`user_dns_record`表中创建记录
- 初始状态设为`PENDING`（待同步）
- 记录用户ID、子域名ID、DNS配置等信息

### 3. DNSPod API同步
- 构建完整的主机记录（name.subdomain）
- 调用腾讯云DNSPod添加记录接口
- 处理API响应结果

### 4. 状态更新
- 同步成功：更新本地记录的DNSPod记录ID和状态为SUCCESS
- 同步失败：更新状态为FAILED并记录错误信息

### 5. 异常处理
- 事务回滚保证数据一致性
- 详细的错误日志和状态跟踪

## 记录类型说明

| 记录类型 | 描述 | 值格式示例 | 特殊要求 |
|---------|------|-----------|----------|
| A | IPv4地址记录 | 192.168.1.1 | 必须是有效的IPv4地址 |
| AAAA | IPv6地址记录 | 2001:db8::1 | 必须是有效的IPv6地址 |
| CNAME | 别名记录 | example.com | 必须是有效的域名格式 |
| MX | 邮件交换记录 | mail.example.com | 需要设置mx优先级 |
| TXT | 文本记录 | "v=spf1 include:_spf.example.com ~all" | 长度不超过255字符 |
| NS | 域名服务器记录 | ns1.example.com | 必须是有效的域名格式 |

## 主机记录说明

| 主机记录 | 描述 | 完整域名示例 |
|---------|------|-------------|
| @ | 主域名 | test.cblog.eu |
| www | WWW子域名 | www.test.cblog.eu |
| mail | 邮件子域名 | mail.test.cblog.eu |
| ftp | FTP子域名 | ftp.test.cblog.eu |
| * | 泛域名 | *.test.cblog.eu |

## 错误码说明

| 错误码 | 描述 | 解决方案 |
|-------|------|----------|
| 400 | 参数错误 | 检查必填参数是否完整，参数格式是否正确 |
| 401 | 未授权 | 检查JWT令牌是否有效 |
| 403 | 权限不足 | 确保操作的是自己的子域名 |
| 404 | 子域名不存在 | 检查subdomainId是否正确 |
| 409 | 记录冲突 | 记录已存在，请检查是否重复添加 |
| 500 | 服务器错误 | 检查DNSPod API配置，查看详细错误信息 |

## 注意事项

1. **权限控制**：用户只能为自己的3级域名添加解析记录
2. **记录唯一性**：同一子域名下，相同主机记录和记录类型的记录不能重复
3. **状态管理**：记录创建后会自动同步到DNSPod，状态会相应更新
4. **格式验证**：系统会验证记录值的格式，确保符合DNS规范
5. **TTL限制**：TTL值范围为1-604800秒
6. **MX记录**：添加MX记录时必须设置mx参数（优先级1-20）
7. **CNAME限制**：CNAME记录不能与其他记录类型共存于同一主机记录下

## 相关接口

- [获取用户DNS解析记录列表](./用户获取DNS解析记录列表接口.md)
- [删除用户DNS解析记录](./用户删除DNS解析记录接口.md)
- [获取用户3级域名列表](./获取当前用户域名列表接口.md)

## 测试用例

### 测试用例1：成功添加A记录

**请求参数**：
```json
{
  "subdomainId": 123,
  "name": "www",
  "type": "A",
  "value": "192.168.1.1",
  "ttl": 600,
  "remark": "测试记录"
}
```

**预期响应**：
- code=200
- data包含完整的记录信息
- syncStatus="SUCCESS"

### 测试用例2：添加重复记录

**前置条件**：已存在相同的记录

**请求参数**：
```json
{
  "subdomainId": 123,
  "name": "www",
  "type": "A",
  "value": "192.168.1.2"
}
```

**预期响应**：
- code=409
- message="DNS解析记录已存在"

### 测试用例3：无效的IP地址

**请求参数**：
```json
{
  "subdomainId": 123,
  "name": "www",
  "type": "A",
  "value": "invalid-ip"
}
```

**预期响应**：
- code=400
- message包含"记录值格式不正确"

### 测试用例4：操作他人的子域名

**请求参数**：
```json
{
  "subdomainId": 999,
  "name": "www",
  "type": "A",
  "value": "192.168.1.1"
}
```

**预期响应**：
- code=403
- message="无权限操作该子域名"

## 接口安全

1. **身份认证**：所有请求必须携带有效的JWT令牌
2. **权限验证**：确保用户只能操作自己的资源
3. **参数验证**：严格验证所有输入参数
4. **SQL注入防护**：使用参数化查询
5. **事务保护**：确保数据一致性

## 性能优化

1. **数据库索引**：在关键字段上建立索引
2. **缓存机制**：缓存用户域名信息
3. **异步处理**：考虑将DNSPod同步改为异步处理
4. **批量操作**：支持批量添加记录
5. **连接池**：使用连接池管理数据库连接