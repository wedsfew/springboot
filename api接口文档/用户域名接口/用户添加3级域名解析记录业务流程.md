# 用户添加3级域名解析记录业务流程

## 一、业务流程概述

用户添加3级域名解析记录是一个涉及本地数据库存储和DNSPod API同步的完整业务流程。该流程确保用户的DNS解析记录既保存在本地数据库中，又能同步到DNSPod进行实际的DNS解析。

## 二、业务流程图

```
用户请求添加DNS记录
        ↓
1. 用户身份验证(JWT)
        ↓
2. 参数验证和业务规则检查
        ↓
3. 检查用户是否拥有该3级域名
        ↓
4. 检查DNS记录是否已存在
        ↓
5. 保存记录到本地数据库(状态:PENDING)
        ↓
6. 调用DNSPod API添加记录
        ↓
7. 更新本地记录状态和DNSPod记录ID
        ↓
8. 返回操作结果给用户
```

## 三、详细业务流程

### 3.1 前置条件检查

#### 步骤1：用户身份验证
- **目的**：确保只有登录用户才能添加DNS记录
- **实现**：通过JWT令牌验证用户身份
- **失败处理**：返回401未授权错误

#### 步骤2：参数验证
- **验证项目**：
  - 子域名ID是否存在
  - 记录类型是否有效（A、CNAME、MX、TXT等）
  - 记录值格式是否正确
  - TTL值是否在有效范围内
- **失败处理**：返回400参数错误

#### 步骤3：权限验证
- **检查内容**：
  - 用户是否拥有指定的3级域名
  - 3级域名状态是否为ACTIVE
- **SQL查询**：
  ```sql
  SELECT * FROM user_subdomain 
  WHERE id = #{subdomainId} AND user_id = #{userId} AND status = 'ACTIVE'
  ```
- **失败处理**：返回403权限不足错误

### 3.2 业务规则检查

#### 步骤4：重复记录检查
- **检查逻辑**：同一子域名下不能有相同的主机记录+记录类型组合
- **SQL查询**：
  ```sql
  SELECT COUNT(*) FROM user_dns_record 
  WHERE user_id = #{userId} AND subdomain_id = #{subdomainId} 
  AND name = #{name} AND type = #{type}
  ```
- **失败处理**：返回409冲突错误

#### 步骤5：记录数量限制检查
- **检查内容**：用户DNS记录总数是否超过限制
- **业务规则**：普通用户最多100条记录，VIP用户最多1000条记录
- **失败处理**：返回429请求过多错误

### 3.3 本地数据库操作

#### 步骤6：创建本地DNS记录
- **操作**：在user_dns_record表中插入新记录
- **初始状态**：sync_status = 'PENDING'
- **记录内容**：
  ```java
  UserDnsRecord record = new UserDnsRecord();
  record.setUserId(userId);
  record.setSubdomainId(subdomainId);
  record.setName(name);
  record.setType(type);
  record.setValue(value);
  record.setTtl(ttl);
  record.setStatus("ENABLE");
  record.setSyncStatus("PENDING");
  ```

### 3.4 DNSPod API同步

#### 步骤7：调用DNSPod添加记录API
- **API接口**：`POST /api/dnspod/records`
- **请求参数**：
  ```json
  {
    "domain": "example.com",
    "recordType": "A",
    "value": "192.168.1.1",
    "subDomain": "test",
    "recordLine": "默认",
    "ttl": 600,
    "remark": "用户添加的记录"
  }
  ```

#### 步骤8：处理DNSPod响应
- **成功情况**：
  - 获取DNSPod返回的记录ID
  - 更新本地记录：record_id = dnspod_record_id, sync_status = 'SUCCESS'
- **失败情况**：
  - 更新本地记录：sync_status = 'FAILED', sync_error = 错误信息
  - 可选择删除本地记录或保留用于重试

### 3.5 结果返回

#### 步骤9：构造响应结果
- **成功响应**：
  ```json
  {
    "code": 200,
    "message": "DNS解析记录添加成功",
    "data": {
      "id": 123,
      "name": "test",
      "type": "A",
      "value": "192.168.1.1",
      "ttl": 600,
      "status": "ENABLE",
      "syncStatus": "SUCCESS",
      "recordId": 456789,
      "createTime": "2025-08-25T08:00:00"
    }
  }
  ```

- **失败响应**：
  ```json
  {
    "code": 500,
    "message": "DNS解析记录添加失败：DNSPod API调用失败",
    "data": null
  }
  ```

## 四、异常处理机制

### 4.1 事务管理
- **本地数据库操作**：使用数据库事务确保数据一致性
- **API调用失败**：回滚本地数据库操作或标记为失败状态

### 4.2 重试机制
- **自动重试**：对于网络超时等临时性错误，实现自动重试
- **手动重试**：提供管理接口，允许手动重试失败的同步操作

### 4.3 监控和告警
- **同步状态监控**：定期检查PENDING和FAILED状态的记录
- **失败告警**：当失败记录数量超过阈值时发送告警

## 五、API接口设计

### 5.1 请求接口
```http
POST /api/user/dns-records
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "subdomainId": 123,
  "name": "www",
  "type": "A",
  "value": "192.168.1.1",
  "ttl": 600,
  "remark": "网站主页"
}
```

### 5.2 响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 456,
    "subdomainId": 123,
    "name": "www",
    "type": "A",
    "value": "192.168.1.1",
    "ttl": 600,
    "status": "ENABLE",
    "syncStatus": "SUCCESS",
    "recordId": 789012,
    "remark": "网站主页",
    "createTime": "2025-08-25T08:00:00",
    "updateTime": "2025-08-25T08:00:00"
  }
}
```

## 六、数据库设计要点

### 6.1 核心表结构
- **user_dns_record**：存储DNS解析记录
- **user_subdomain**：存储用户3级域名
- **user**：用户基础信息

### 6.2 关键字段
- **sync_status**：同步状态（PENDING/SUCCESS/FAILED）
- **record_id**：DNSPod记录ID
- **sync_error**：同步错误信息

## 七、性能优化建议

### 7.1 异步处理
- **异步同步**：将DNSPod API调用放入消息队列异步处理
- **批量操作**：支持批量添加多条DNS记录

### 7.2 缓存策略
- **记录缓存**：缓存用户的DNS记录列表
- **域名缓存**：缓存用户的3级域名列表

### 7.3 限流控制
- **用户限流**：限制单个用户的操作频率
- **API限流**：控制对DNSPod API的调用频率

## 八、安全考虑

### 8.1 权限控制
- **用户隔离**：确保用户只能操作自己的DNS记录
- **域名验证**：验证用户对3级域名的所有权

### 8.2 输入验证
- **参数校验**：严格验证所有输入参数
- **SQL注入防护**：使用参数化查询防止SQL注入

### 8.3 日志记录
- **操作日志**：记录所有DNS记录操作
- **错误日志**：详细记录错误信息用于排查

## 九、测试用例

### 9.1 正常流程测试
- 用户成功添加A记录
- 用户成功添加CNAME记录
- 用户成功添加MX记录

### 9.2 异常流程测试
- 重复记录添加测试
- 权限不足测试
- DNSPod API失败测试
- 网络超时测试

### 9.3 边界条件测试
- 记录数量限制测试
- TTL值边界测试
- 特殊字符处理测试

这个业务流程确保了用户添加3级域名解析记录的完整性、安全性和可靠性。