# 删除3级域名解析记录业务流程

## 一、业务流程概述

删除3级域名解析记录是一个涉及本地数据库和DNSPod API同步的完整业务流程。该流程确保用户的DNS解析记录能够从本地数据库和DNSPod服务中同步删除，保持数据一致性。

## 二、业务流程图

```
用户请求删除DNS记录
        ↓
1. 用户身份验证(JWT)
        ↓
2. 检查用户是否拥有该DNS记录
        ↓
3. 检查记录是否存在
        ↓
4. 从DNSPod删除记录
        ↓
5. 从本地数据库删除记录
        ↓
6. 返回操作结果给用户
```

## 三、详细业务流程

### 3.1 前置条件检查

#### 步骤1：用户身份验证
- **目的**：确保只有登录用户才能删除DNS记录
- **实现**：通过JWT令牌验证用户身份
- **失败处理**：返回401未授权错误

#### 步骤2：权限验证
- **检查内容**：
  - 用户是否拥有指定的DNS记录
- **SQL查询**：
  ```sql
  SELECT * FROM user_dns_record 
  WHERE id = #{recordId} AND user_id = #{userId}
  ```
- **失败处理**：返回403权限不足错误

#### 步骤3：记录存在性检查
- **检查逻辑**：确认要删除的记录存在且属于当前用户
- **失败处理**：返回404记录不存在错误

### 3.2 DNSPod API同步

#### 步骤4：调用DNSPod删除记录API
- **条件**：仅当记录已成功同步到DNSPod（sync_status = 'SUCCESS'）且有DNSPod记录ID时执行
- **API接口**：`deleteRecord`方法
- **请求参数**：
  ```java
  dnspodService.deleteRecord(mainDomain, record.getRecordId(), null);
  ```
- **异常处理**：
  - 如果DNSPod API调用失败，记录错误但继续执行本地删除
  - 记录警告日志：`从DNSPod删除记录失败，但继续删除本地记录: {错误信息}`

### 3.3 本地数据库操作

#### 步骤5：删除本地DNS记录
- **操作**：从user_dns_record表中删除记录
- **SQL操作**：
  ```sql
  DELETE FROM user_dns_record WHERE id = #{id}
  ```
- **事务管理**：使用@Transactional注解确保操作的原子性
- **失败处理**：如果删除失败，返回500内部服务器错误

### 3.4 结果返回

#### 步骤6：构造响应结果
- **成功响应**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": true,
    "timestamp": "2025-08-25T08:00:00Z"
  }
  ```

- **失败响应**：
  ```json
  {
    "code": 500,
    "message": "删除DNS解析记录失败: {错误信息}",
    "data": null,
    "timestamp": "2025-08-25T08:00:00Z"
  }
  ```

## 四、异常处理机制

### 4.1 DNSPod API调用异常
- **处理策略**：记录警告日志，但继续执行本地删除操作
- **原因**：即使DNSPod删除失败，也应该允许用户删除本地记录，避免记录状态不一致
- **后续处理**：可以通过定期同步任务清理DNSPod中的孤立记录

### 4.2 数据库操作异常
- **处理策略**：回滚事务，返回错误信息
- **日志记录**：详细记录错误信息，便于排查问题

### 4.3 并发控制
- **事务隔离级别**：使用默认的隔离级别（通常为READ_COMMITTED）
- **锁策略**：依赖数据库的行级锁机制

## 五、API接口设计

### 5.1 请求接口
```http
DELETE /api/user/dns-records/{id}
Authorization: Bearer {jwt_token}
```

### 5.2 响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": true,
  "timestamp": "2025-08-25T08:00:00Z"
}
```

## 六、安全考虑

### 6.1 权限控制
- **用户隔离**：确保用户只能删除自己的DNS记录
- **记录验证**：验证用户对DNS记录的所有权

### 6.2 操作日志
- **日志记录**：记录所有删除操作，包括操作用户、操作时间、记录ID等信息
- **审计追踪**：支持后续审计和问题排查

### 6.3 防护措施
- **幂等性**：重复删除同一记录应返回相同的结果（记录不存在）
- **并发保护**：通过事务和锁机制防止并发操作导致的问题

## 七、实现示例

### 7.1 控制器方法
```java
/**
 * 删除DNS解析记录
 * 
 * @param id 记录ID
 * @param authHeader Authorization头信息
 * @return 删除结果
 */
@DeleteMapping("/{id}")
@Transactional
public ApiResponse<Boolean> deleteDnsRecord(
        @PathVariable Long id,
        @RequestHeader("Authorization") String authHeader) {
    try {
        // 从Authorization头中提取token
        String token = authHeader.replace("Bearer ", "");
        
        // 从token中获取用户ID
        Long userId = jwtUtil.getUserIdFromToken(token);
        
        UserDnsRecord record = userDnsRecordService.getRecordById(id);
        if (record == null) {
            return ApiResponse.error(404, "DNS解析记录不存在");
        }
        
        if (!record.getUserId().equals(userId)) {
            return ApiResponse.error(403, "无权限删除该DNS解析记录");
        }
        
        // 如果记录已同步到DNSPod，需要先从DNSPod删除
        if ("SUCCESS".equals(record.getSyncStatus()) && record.getRecordId() != null) {
            try {
                UserSubdomain userSubdomain = userSubdomainService.getById(record.getSubdomainId());
                if (userSubdomain != null) {
                    String[] domainParts = userSubdomain.getFullDomain().split("\\.", 2);
                    if (domainParts.length == 2) {
                        String mainDomain = domainParts[1];
                        dnspodService.deleteRecord(mainDomain, record.getRecordId(), null);
                        log.info("从DNSPod删除记录成功: recordId={}", record.getRecordId());
                    }
                }
            } catch (Exception e) {
                log.warn("从DNSPod删除记录失败，但继续删除本地记录: {}", e.getMessage());
            }
        }
        
        // 删除本地记录
        boolean deleted = userDnsRecordService.deleteRecord(id);
        if (deleted) {
            log.info("用户 {} 删除DNS解析记录成功: recordId={}", userId, id);
            return ApiResponse.success(true);
        } else {
            return ApiResponse.error(500, "删除DNS解析记录失败");
        }
        
    } catch (Exception e) {
        log.error("删除DNS解析记录失败", e);
        return ApiResponse.error(500, "删除DNS解析记录失败: " + e.getMessage());
    }
}
```

## 八、测试用例

### 8.1 成功场景
- **前置条件**：用户已登录，且拥有要删除的DNS记录
- **操作**：发送DELETE请求到`/api/user/dns-records/{id}`
- **预期结果**：
  - 状态码：200
  - 响应体：`{"code":200,"message":"操作成功","data":true}`
  - 数据库：记录已从user_dns_record表中删除
  - DNSPod：记录已从DNSPod服务中删除

### 8.2 记录不存在
- **前置条件**：用户已登录，但记录ID不存在
- **操作**：发送DELETE请求到`/api/user/dns-records/{不存在的ID}`
- **预期结果**：
  - 状态码：404
  - 响应体：`{"code":404,"message":"DNS解析记录不存在","data":null}`

### 8.3 无权限删除
- **前置条件**：用户已登录，但记录属于其他用户
- **操作**：发送DELETE请求到`/api/user/dns-records/{其他用户的记录ID}`
- **预期结果**：
  - 状态码：403
  - 响应体：`{"code":403,"message":"无权限删除该DNS解析记录","data":null}`

## 九、注意事项

1. **删除操作不可恢复**：提醒用户删除操作是永久性的，无法撤销
2. **DNS生效时间**：即使删除成功，DNS缓存可能导致实际生效有延迟
3. **错误处理**：DNSPod API调用失败不应阻止本地记录删除
4. **批量删除**：当前设计不支持批量删除，如有需要可以扩展接口
5. **关联数据**：删除记录时应考虑是否有其他关联数据需要处理