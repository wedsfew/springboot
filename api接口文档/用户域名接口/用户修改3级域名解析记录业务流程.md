# 用户修改3级域名解析记录业务流程

## 一、业务流程概述

用户修改3级域名解析记录是一个涉及本地数据库更新和DNSPod API同步的完整业务流程。该流程确保用户的DNS解析记录修改既保存在本地数据库中，又能同步到DNSPod进行实际的DNS解析更新。

## 二、业务流程图

```
用户请求修改DNS记录
        ↓
1. 用户身份验证(JWT)
        ↓
2. 参数验证和业务规则检查
        ↓
3. 检查用户是否拥有该DNS记录
        ↓
4. 检查记录是否存在
        ↓
5. 更新本地数据库记录(状态:PENDING)
        ↓
6. 调用DNSPod API修改记录
        ↓
7. 更新本地记录状态
        ↓
8. 返回操作结果给用户
```

## 三、详细业务流程

### 3.1 前置条件检查

#### 步骤1：用户身份验证
- **目的**：确保只有登录用户才能修改DNS记录
- **实现**：通过JWT令牌验证用户身份
- **失败处理**：返回401未授权错误

#### 步骤2：参数验证
- **验证项目**：
  - 记录ID是否存在
  - 记录类型是否有效（A、CNAME、MX、TXT等）
  - 记录值格式是否正确
  - TTL值是否在有效范围内
- **失败处理**：返回400参数错误

#### 步骤3：权限验证
- **检查内容**：
  - 用户是否拥有指定的DNS记录
  - 记录状态是否正常
- **SQL查询**：
  ```sql
  SELECT * FROM user_dns_record 
  WHERE id = #{recordId} AND user_id = #{userId}
  ```
- **失败处理**：返回403权限不足错误

### 3.2 业务规则检查

#### 步骤4：记录存在性检查
- **检查逻辑**：确认要修改的记录存在且属于当前用户
- **失败处理**：返回404记录不存在错误

#### 步骤5：记录类型约束检查
- **检查内容**：如果修改记录类型，需要确保不与同一主机记录下的其他记录冲突
- **业务规则**：例如，CNAME记录不能与其他记录类型共存于同一主机记录下
- **失败处理**：返回409冲突错误

### 3.3 本地数据库操作

#### 步骤6：更新本地DNS记录
- **操作**：在user_dns_record表中更新记录
- **更新状态**：sync_status = 'PENDING'
- **记录内容**：
  ```java
  UserDnsRecord record = userDnsRecordService.getRecordById(recordId);
  record.setType(request.getType());
  record.setValue(request.getValue());
  record.setTtl(request.getTtl());
  record.setMx(request.getMx());
  record.setWeight(request.getWeight());
  record.setStatus(request.getStatus());
  record.setRemark(request.getRemark());
  record.setSyncStatus("PENDING");
  record.setSyncError(null);
  ```

### 3.4 DNSPod API同步

#### 步骤7：调用DNSPod修改记录API
- **API接口**：`POST /api/dnspod/records/modify`
- **请求参数**：
  ```json
  {
    "domain": "example.com",
    "recordId": 123456,
    "recordType": "A",
    "value": "192.168.1.1",
    "recordLine": "默认",
    "subDomain": "test",
    "ttl": 600,
    "remark": "用户修改的记录"
  }
  ```

#### 步骤8：处理DNSPod响应
- **成功情况**：
  - 更新本地记录：sync_status = 'SUCCESS'
- **失败情况**：
  - 更新本地记录：sync_status = 'FAILED', sync_error = 错误信息
  - 可选择回滚到原始记录值或保留修改后的值用于重试

### 3.5 结果返回

#### 步骤9：构造响应结果
- **成功响应**：
  ```json
  {
    "code": 200,
    "message": "DNS解析记录修改成功",
    "data": {
      "id": 123,
      "name": "test",
      "type": "A",
      "value": "192.168.1.1",
      "ttl": 600,
      "status": "ENABLE",
      "syncStatus": "SUCCESS",
      "recordId": 456789,
      "updateTime": "2025-08-25T08:00:00"
    }
  }
  ```

- **失败响应**：
  ```json
  {
    "code": 500,
    "message": "DNS解析记录修改失败：DNSPod API调用失败",
    "data": null
  }
  ```

## 四、异常处理机制

### 4.1 事务管理
- **本地数据库操作**：使用数据库事务确保数据一致性
- **API调用失败**：记录错误信息并标记为失败状态

### 4.2 重试机制
- **自动重试**：对于网络超时等临时性错误，实现自动重试
- **手动重试**：提供管理接口，允许手动重试失败的同步操作

### 4.3 监控和告警
- **同步状态监控**：定期检查PENDING和FAILED状态的记录
- **失败告警**：当失败记录数量超过阈值时发送告警

## 五、API接口设计

### 5.1 请求接口
```http
PUT /api/user/dns-records/{id}
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "type": "A",
  "value": "192.168.1.2",
  "ttl": 600,
  "remark": "更新后的网站主页"
}
```

### 5.2 响应格式
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 456,
    "subdomainId": 123,
    "name": "www",
    "type": "A",
    "value": "192.168.1.2",
    "ttl": 600,
    "status": "ENABLE",
    "syncStatus": "SUCCESS",
    "recordId": 789012,
    "remark": "更新后的网站主页",
    "createTime": "2025-08-25T08:00:00",
    "updateTime": "2025-08-25T08:10:00"
  }
}
```

## 六、数据库设计要点

### 6.1 核心表结构
- **user_dns_record**：存储DNS解析记录
- **user_subdomain**：存储用户3级域名
- **user**：用户基础信息

### 6.2 关键字段
- **sync_status**：同步状态（PENDING/SUCCESS/FAILED）
- **record_id**：DNSPod记录ID
- **sync_error**：同步错误信息

## 七、性能优化建议

### 7.1 异步处理
- **异步同步**：将DNSPod API调用放入消息队列异步处理
- **批量操作**：支持批量修改多条DNS记录

### 7.2 缓存策略
- **记录缓存**：缓存用户的DNS记录列表
- **域名缓存**：缓存用户的3级域名列表

### 7.3 限流控制
- **用户限流**：限制单个用户的操作频率
- **API限流**：控制对DNSPod API的调用频率

## 八、安全考虑

### 8.1 权限控制
- **用户隔离**：确保用户只能修改自己的DNS记录
- **域名验证**：验证用户对DNS记录的所有权

### 8.2 输入验证
- **参数校验**：严格验证所有输入参数
- **SQL注入防护**：使用参数化查询防止SQL注入

### 8.3 日志记录
- **操作日志**：记录所有DNS记录修改操作
- **错误日志**：详细记录错误信息用于排查

## 九、测试用例

### 9.1 正常流程测试
- 用户成功修改A记录的IP地址
- 用户成功修改CNAME记录的目标域名
- 用户成功修改MX记录的优先级

### 9.2 异常流程测试
- 修改不存在的记录测试
- 权限不足测试
- DNSPod API失败测试
- 网络超时测试

### 9.3 边界条件测试
- TTL值边界测试
- 特殊字符处理测试
- 记录类型变更测试

这个业务流程确保了用户修改3级域名解析记录的完整性、安全性和可靠性。