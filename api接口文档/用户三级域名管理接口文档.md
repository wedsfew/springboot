# 用户三级域名管理接口文档

## 接口概述

本文档描述了用户三级域名管理相关的API接口，包括注册三级域名、查询用户的三级域名列表以及删除用户的三级域名。

## 接口列表

| 接口名称 | 请求方式 | 接口路径 | 描述 |
| ------- | ------- | ------- | ---- |
| 注册三级域名 | POST | /api/user/domains/register | 用户注册三级域名 |
| 查询用户三级域名列表 | GET | /api/user/domains/subdomains | 查询当前用户的所有三级域名 |
| 删除用户三级域名 | DELETE | /api/user/domains/subdomains/{id} | 删除指定的三级域名 |

## 1. 注册三级域名

### 接口说明

该接口用于用户注册三级域名，将用户邮箱（从JWT令牌中获取）作为备注添加到DNS记录中，并将记录保存到数据库。

### 请求URL

```
POST /api/user/domains/register
```

### 请求头

| 参数名 | 类型 | 是否必须 | 描述 |
| ----- | --- | ------- | ---- |
| Authorization | String | 是 | Bearer {JWT令牌} |

### 请求参数

| 参数名 | 类型 | 是否必须 | 描述 |
| ----- | --- | ------- | ---- |
| subDomain | String | 是 | 子域名前缀，如"test" |
| domain | String | 是 | 主域名，默认为"cblog.eu" |
| value | String | 是 | IP地址，如"8.8.8.8" |
| ttl | Long | 否 | TTL值，默认为600秒 |

### 请求示例

```json
{
  "domain": "cblog.eu",
  "subDomain" : "test",
  "value": "8.8.8.8",
  "ttl": 600
}
```

### 响应参数

| 参数名 | 类型 | 描述 |
| ----- | --- | ---- |
| code | Integer | 状态码，200表示成功 |
| message | String | 响应消息 |
| data | Object | 响应数据，包含DNSPod API的返回结果 |
| timestamp | String | 时间戳 |

### 响应示例

```json
{
  "code": 200,
  "message": "域名 test.cblog.eu 注册成功",
  "data": {
    "skipSign": false,
    "requestId": "787f2e08-0e92-4f9d-be69-9e7cccc2dd08",
    "recordId": 2171170645
  },
  "timestamp": "2025-08-22T02:33:06.673151026"
}
```

### 错误码

| 错误码 | 描述 |
| ----- | ---- |
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权：需要有效的JWT令牌 |
| 409 | 域名已被注册 |
| 500 | 服务器内部错误 |

### 业务流程

1. 从JWT令牌中获取用户邮箱和用户ID
2. 验证请求参数的有效性
3. 检查三级域名是否可用
4. 如果域名可用，添加A记录，并将用户邮箱作为备注
5. 将用户三级域名记录保存到数据库
6. 返回注册结果

## 2. 查询用户三级域名列表

### 接口说明

该接口用于查询当前用户的所有三级域名记录。

### 请求URL

```
GET /api/user/domains/subdomains
```

### 请求头

| 参数名 | 类型 | 是否必须 | 描述 |
| ----- | --- | ------- | ---- |
| Authorization | String | 是 | Bearer {JWT令牌} |

### 响应参数

| 参数名 | 类型 | 描述 |
| ----- | --- | ---- |
| code | Integer | 状态码，200表示成功 |
| message | String | 响应消息 |
| data | Array | 用户三级域名记录列表 |
| timestamp | String | 时间戳 |

### 响应示例

```json
{
  "code": 200,
  "message": "查询成功",
  "data": [
    {
      "id": 1,
      "userId": 1,
      "subdomain": "test",
      "domain": "cblog.eu",
      "recordId": 2171170645,
      "ipAddress": "8.8.8.8",
      "ttl": 600,
      "status": "ACTIVE",
      "createTime": "2025-08-22T02:33:06.673151026",
      "updateTime": "2025-08-22T02:33:06.673151026"
    }
  ],
  "timestamp": "2025-08-22T02:40:15.123456789"
}
```

### 错误码

| 错误码 | 描述 |
| ----- | ---- |
| 200 | 成功 |
| 401 | 未授权：需要有效的JWT令牌 |
| 500 | 服务器内部错误 |

### 业务流程

1. 从JWT令牌中获取用户ID
2. 查询用户的三级域名列表
3. 返回查询结果

## 3. 删除用户三级域名

### 接口说明

该接口用于删除指定的三级域名记录，包括从DNSPod删除记录和在数据库中逻辑删除记录。

### 请求URL

```
DELETE /api/user/domains/subdomains/{id}
```

### 请求头

| 参数名 | 类型 | 是否必须 | 描述 |
| ----- | --- | ------- | ---- |
| Authorization | String | 是 | Bearer {JWT令牌} |

### 路径参数

| 参数名 | 类型 | 是否必须 | 描述 |
| ----- | --- | ------- | ---- |
| id | Long | 是 | 三级域名记录ID |

### 响应参数

| 参数名 | 类型 | 描述 |
| ----- | --- | ---- |
| code | Integer | 状态码，200表示成功 |
| message | String | 响应消息 |
| data | Object | 响应数据，为null |
| timestamp | String | 时间戳 |

### 响应示例

```json
{
  "code": 200,
  "message": "三级域名删除成功",
  "data": null,
  "timestamp": "2025-08-22T02:45:30.123456789"
}
```

### 错误码

| 错误码 | 描述 |
| ----- | ---- |
| 200 | 成功 |
| 401 | 未授权：需要有效的JWT令牌 |
| 403 | 无权操作：该三级域名不属于当前用户 |
| 404 | 三级域名记录不存在 |
| 500 | 服务器内部错误 |

### 业务流程

1. 从JWT令牌中获取用户ID
2. 查询三级域名记录
3. 验证记录是否存在
4. 验证记录是否属于当前用户
5. 从DNSPod删除记录
6. 在数据库中逻辑删除记录
7. 返回删除结果

## 数据库表结构

用户三级域名记录存储在`user_subdomain`表中，表结构如下：

```sql
CREATE TABLE `user_subdomain` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `subdomain` varchar(100) NOT NULL COMMENT '子域名前缀',
  `domain` varchar(100) NOT NULL COMMENT '主域名',
  `record_id` bigint NOT NULL COMMENT 'DNSPod记录ID',
  `ip_address` varchar(100) NOT NULL COMMENT 'IP地址',
  `ttl` int NOT NULL DEFAULT '600' COMMENT 'TTL值',
  `status` varchar(20) NOT NULL DEFAULT 'ACTIVE' COMMENT '状态：ACTIVE-活跃，INACTIVE-不活跃，DELETED-已删除',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_subdomain` (`user_id`, `subdomain`, `domain`),
  UNIQUE KEY `uk_subdomain_domain` (`subdomain`, `domain`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  KEY `idx_create_time` (`create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='用户三级域名表';
```

## 注意事项

1. 所有接口都需要JWT令牌认证，请在请求头中添加`Authorization: Bearer {JWT令牌}`
2. 子域名前缀只能包含字母、数字和连字符，且长度不能超过63个字符
3. IP地址必须是有效的IPv4或IPv6地址
4. TTL值必须大于等于600秒
5. 每个用户最多可以注册10个三级域名
6. 三级域名一旦被注册，其他用户将无法注册相同的三级域名
7. 删除三级域名操作不可逆，请谨慎操作

## 测试用例

### 注册三级域名

```bash
curl -X POST "http://localhost:8080/api/user/domains/register" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "subDomain": "test",
    "value": "8.8.8.8"
  }'
```

### 查询用户三级域名列表

```bash
curl -X GET "http://localhost:8080/api/user/domains/subdomains" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

### 删除用户三级域名

```bash
curl -X DELETE "http://localhost:8080/api/user/domains/subdomains/1" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## 版本历史

| 版本号 | 发布日期 | 更新说明 |
| ----- | ------- | ------- |
| v1.0.0 | 2025-08-22 | 初始版本，包含注册三级域名功能 |
| v1.1.0 | 2025-08-22 | 添加查询用户三级域名列表和删除用户三级域名功能 |