# 免费3级域名服务业务文档

## 业务概述

本服务为用户提供免费的3级域名（如 a.cblog.eu）和DNS解析服务，基于腾讯云DNSPod API实现。用户可以申请、管理自己的3级域名，并配置DNS解析记录。

## 核心业务流程

### 1. 用户域名申请流程

#### 1.1 用户申请域名
**业务描述**: 用户提交3级域名申请，系统检查可用性和配额限制

**调用接口**:
1. `GET /api/domain-service/available-domains` - 获取可用主域名列表
2. `POST /api/domain-service/check-subdomain` - 检查子域名可用性
3. `POST /api/domain-service/apply` - 提交域名申请

**业务流程**:
```
用户登录 → 查看可用域名 → 输入子域名 → 检查可用性 → 提交申请
```

#### 1.2 系统自动审核
**业务描述**: 系统自动审核用户的域名申请，检查规则后自动批准或拒绝

**自动审核规则**:
1. 检查子域名格式是否合法（3-20字符，字母数字下划线）
2. 检查子域名是否已被占用
3. 检查用户配额是否充足
4. 检查是否包含敏感词汇
5. 检查用户账户状态是否正常

**业务流程**:
```
用户提交申请 → 系统自动验证规则 → 自动批准/拒绝 → 创建域名记录/返回拒绝原因
```

#### 1.3 域名自动创建
**业务描述**: 申请通过自动审核后，系统立即在DNSPod创建域名记录

**调用接口**:
1. `POST /api/dnspod/domains/{domain}/records` - 在DNSPod创建DNS记录
2. 内部服务：更新user_domains表和user_quotas表

### 2. 用户域名管理流程

#### 2.1 查看我的域名
**业务描述**: 用户查看自己拥有的域名列表和状态

**调用接口**:
1. `GET /api/domain-service/my-domains` - 获取用户域名列表
2. `GET /api/domain-service/my-domains/{id}` - 获取域名详情

#### 2.2 管理DNS记录
**业务描述**: 用户为自己的域名添加、修改、删除DNS解析记录

**调用接口**:
1. `GET /api/domain-service/domains/{domainId}/dns-records` - 获取域名的DNS记录
2. `POST /api/domain-service/domains/{domainId}/dns-records` - 添加DNS记录
3. `PUT /api/domain-service/domains/{domainId}/dns-records/{recordId}` - 修改DNS记录
4. `DELETE /api/domain-service/domains/{domainId}/dns-records/{recordId}` - 删除DNS记录

**业务流程**:
```
用户登录 → 选择域名 → 查看DNS记录 → 添加/修改/删除记录 → 同步到DNSPod
```

#### 2.3 域名续期/释放
**业务描述**: 用户可以续期域名或主动释放域名

**调用接口**:
1. `PUT /api/domain-service/domains/{id}/renew` - 续期域名
2. `DELETE /api/domain-service/domains/{id}` - 释放域名

### 3. 管理员管理流程

#### 3.1 域名资源管理
**业务描述**: 管理员管理可分配的主域名资源

**调用接口**:
1. `GET /api/admin/domains` - 获取主域名列表
2. `POST /api/admin/domains` - 添加新的主域名
3. `PUT /api/admin/domains/{id}` - 更新主域名配置
4. `DELETE /api/admin/domains/{id}` - 删除主域名

#### 3.2 用户配额管理
**业务描述**: 管理员管理用户的域名和DNS记录配额

**调用接口**:
1. `GET /api/admin/user-quotas` - 获取用户配额列表
2. `PUT /api/admin/user-quotas/{userId}` - 更新用户配额

#### 3.3 系统监控
**业务描述**: 管理员监控系统使用情况和操作日志

**调用接口**:
1. `GET /api/admin/statistics` - 获取系统统计信息
2. `GET /api/admin/operation-logs` - 获取操作日志

## 需要实现的API接口

### 用户端接口 (/api/domain-service/)

#### 1. 域名申请相关
```
GET    /available-domains              获取可用主域名列表
POST   /check-subdomain               检查子域名可用性
POST   /apply                         提交域名申请
GET    /my-applications               获取我的申请记录
```

#### 2. 域名管理相关
```
GET    /my-domains                    获取我的域名列表
GET    /my-domains/{id}               获取域名详情
PUT    /domains/{id}/renew            续期域名
DELETE /domains/{id}                  释放域名
```

#### 3. DNS记录管理
```
GET    /domains/{domainId}/dns-records           获取DNS记录列表
POST   /domains/{domainId}/dns-records          添加DNS记录
PUT    /domains/{domainId}/dns-records/{id}     修改DNS记录
DELETE /domains/{domainId}/dns-records/{id}     删除DNS记录
```

#### 4. 用户配额查询
```
GET    /my-quota                      获取我的配额信息
```

### 管理员端接口 (/api/admin/)

#### 1. 申请记录管理
```
GET    /domain-applications                     获取申请记录列表
GET    /domain-applications/{id}                获取申请详情
PUT    /domain-applications/{id}/manual-review  手动重新审核（异常情况）
```

#### 2. 域名资源管理
```
GET    /domains                       获取主域名列表
POST   /domains                       添加主域名
PUT    /domains/{id}                  更新主域名
DELETE /domains/{id}                  删除主域名
```

#### 3. 用户域名管理
```
GET    /user-domains                  获取所有用户域名
GET    /user-domains/{id}             获取用户域名详情
PUT    /user-domains/{id}/suspend     暂停用户域名
PUT    /user-domains/{id}/activate    激活用户域名
DELETE /user-domains/{id}             删除用户域名
```

#### 4. 配额管理
```
GET    /user-quotas                   获取用户配额列表
PUT    /user-quotas/{userId}          更新用户配额
```

#### 5. 系统监控
```
GET    /statistics                    获取系统统计
GET    /operation-logs                获取操作日志
```

## 详细业务流程图

### 用户申请域名完整流程

```
1. 用户注册/登录
   ↓
2. 调用 GET /api/domain-service/available-domains
   获取可用主域名列表 (cblog.eu等)
   ↓
3. 用户输入想要的子域名前缀 (如: mysite)
   ↓
4. 调用 POST /api/domain-service/check-subdomain
   检查 mysite.cblog.eu 是否可用
   ↓
5. 如果可用，调用 POST /api/domain-service/apply
   提交申请并立即进行自动审核
   ↓
6. 系统自动审核流程:
   - 检查子域名格式是否合法
   - 检查是否包含敏感词汇
   - 检查用户配额是否充足
   - 检查用户账户状态
   ↓
7. 审核通过后系统自动执行:
   - 在user_domains表创建记录
   - 更新user_quotas表的used_domains
   - 更新domains表的used_subdomains
   - 在DNSPod创建基础DNS记录
   - 记录operation_logs
   ↓
8. 用户立即可以调用 GET /api/domain-service/my-domains
   查看自己的域名并开始使用
```

### DNS记录管理流程

```
1. 用户调用 GET /api/domain-service/my-domains
   获取自己的域名列表
   ↓
2. 选择域名，调用 GET /api/domain-service/domains/{domainId}/dns-records
   查看当前DNS记录
   ↓
3. 添加记录: POST /api/domain-service/domains/{domainId}/dns-records
   - 检查用户权限和配额
   - 调用DNSPod API创建记录
   - 在dns_records表保存记录
   - 记录操作日志
   ↓
4. 修改记录: PUT /api/domain-service/domains/{domainId}/dns-records/{id}
   - 检查用户权限
   - 调用DNSPod API修改记录
   - 更新dns_records表
   - 记录操作日志
   ↓
5. 删除记录: DELETE /api/domain-service/domains/{domainId}/dns-records/{id}
   - 检查用户权限
   - 调用DNSPod API删除记录
   - 删除dns_records表记录
   - 记录操作日志
```

## 权限控制

### 用户权限
- 只能管理自己申请的域名
- 只能在配额范围内操作
- 不能访问其他用户的域名和记录

### 管理员权限
- 可以审核所有域名申请
- 可以管理所有用户域名
- 可以调整用户配额
- 可以查看系统统计和日志

## 配额限制

### 免费用户默认配额
- 最大域名数量: 1个
- 每个域名最大DNS记录数: 10条
- 域名有效期: 永久（可配置）

### 配额检查点
1. 申请域名时检查max_domains
2. 添加DNS记录时检查max_dns_records
3. 所有操作都要检查域名状态和过期时间

## 数据同步策略

### DNSPod同步
- 创建DNS记录时同步到DNSPod
- 定期同步DNSPod记录状态到本地数据库
- 处理DNSPod API调用失败的重试机制

### 数据一致性
- 使用事务确保数据库操作的一致性
- 记录所有重要操作到operation_logs表
- 提供数据修复和同步工具

## 监控和告警

### 系统监控指标
- 域名申请数量和通过率
- DNS记录操作成功率
- DNSPod API调用延迟和错误率
- 用户活跃度和配额使用情况

### 告警机制
- DNSPod API调用失败告警
- 域名配额即将用完告警
- 异常操作行为告警